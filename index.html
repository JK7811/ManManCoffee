<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>JKang Market (Fresh Start)</title>
  <style>
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial; background:#0b0b1c; color:#fff}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    .card{border:1px solid rgba(255,255,255,.14);border-radius:14px;padding:12px;margin:12px 0;background:rgba(255,255,255,.06)}
    input,button{padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.25);color:#fff}
    button{cursor:pointer;font-weight:800}
    button.primary{background:#fff;color:#000;border-color:transparent}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .log{white-space:pre-wrap;font:12px/1.4 ui-monospace,Menlo,Consolas;max-height:45vh;overflow:auto;background:rgba(0,0,0,.35);padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.14)}
    .muted{color:rgba(255,255,255,.7);font-size:13px;line-height:1.6}
  </style>
</head>
<body>
<div class="wrap">
  <h1>JKang Market（重新开始）</h1>

  <div class="card">
    <div class="muted">Step 1：确认按钮真的能点到 + Supabase 通不通</div>
    <div class="row" style="margin-top:10px">
      <button id="btnAlert">点我（必须弹窗）</button>
      <button id="btnPing" class="primary">Ping Supabase</button>
    </div>
    <div class="muted" style="margin-top:8px">origin：<span id="origin"></span></div>
  </div>

  <div class="card">
    <div class="muted">Step 2：Email 登录（Magic Link）</div>
    <div class="row" style="margin-top:10px">
      <input id="email" type="email" placeholder="you@example.com" style="flex:1;min-width:240px"/>
      <button id="btnSend" class="primary">Send Link</button>
      <button id="btnLogout">Logout</button>
    </div>
    <div class="muted" style="margin-top:8px">Auth：<b id="auth">-</b> ｜ User：<b id="user">-</b></div>
  </div>

  <div class="card">
    <div class="muted">Step 3：卖家 / 商品（登录后才能用）</div>
    <div class="row" style="margin-top:10px">
      <button id="btnBecomeSeller">Become Seller（创建店铺）</button>
      <button id="btnAddProduct">Add Product（上架一个商品）</button>
      <button id="btnLoadProducts" class="primary">Load Products（所有商品）</button>
    </div>
    <div id="products" class="muted" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <div class="muted">Log（这里一定会有东西）</div>
    <div id="log" class="log">loading…</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ✅ 只改这两行：用你新项目的
  const SUPABASE_URL = "PASTE_YOUR_PROJECT_URL";
  const SUPABASE_ANON_KEY = "PASTE_YOUR_ANON_KEY";

  const $ = (id)=>document.getElementById(id);
  const logEl = $("log");
  function log(m){ logEl.textContent += `\n[${new Date().toISOString()}] ${m}`; logEl.scrollTop = logEl.scrollHeight; }

  window.addEventListener("error", (e)=>log("❌ window.onerror: " + (e.message||e.error)));
  window.addEventListener("unhandledrejection", (e)=>log("❌ unhandledrejection: " + (e.reason?.message||e.reason)));

  $("origin").textContent = location.origin;

  if(!window.supabase){ log("❌ Supabase SDK 没加载到"); }

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
  });

  function setAuth(session){
    if(session?.user){
      $("auth").textContent = "SIGNED_IN ✅";
      $("user").textContent = session.user.email || session.user.id;
    }else{
      $("auth").textContent = "SIGNED_OUT -";
      $("user").textContent = "-";
    }
  }

  supabase.auth.onAuthStateChange((event, session)=>{
    log(`onAuthStateChange: ${event}`);
    setAuth(session);
  });

  async function boot(){
    logEl.textContent = "";
    log("JS running ✅");
    log("origin = " + location.origin);
    log("url = " + SUPABASE_URL);

    const { data, error } = await supabase.auth.getSession();
    if(error) log("❌ getSession error: " + error.message);
    else log("getSession ok ✅ " + (data.session ? "SIGNED_IN" : "SIGNED_OUT"));
    setAuth(data.session);
  }

  $("btnAlert").onclick = ()=>{ alert("clicked ✅"); log("alert clicked ✅"); };

  $("btnPing").onclick = async ()=>{
    try{
      log("Ping…");
      const r = await fetch(SUPABASE_URL + "/rest/v1/", { method:"GET" });
      log("Ping HTTP " + r.status + " (200/401 都算 OK)");
    }catch(e){
      log("❌ Ping failed: " + (e?.message||e));
    }
  };

  $("btnSend").onclick = async ()=>{
    const email = $("email").value.trim();
    if(!email){ log("⚠️ 请输入邮箱"); return; }
    try{
      log("Send OTP… redirectTo=" + location.origin);
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options:{ emailRedirectTo: location.origin }
      });
      if(error) throw error;
      log("✅ 已发送登录邮件：去邮箱点击链接回到本站完成登录");
    }catch(e){
      log("❌ Send OTP failed: " + (e?.message||e));
      log("检查：Email provider / Redirect URLs / rate limit");
    }
  };

  $("btnLogout").onclick = async ()=>{
    try{
      log("signOut…");
      const { error } = await supabase.auth.signOut();
      if(error) throw error;
      log("signOut ok ✅");
      localStorage.clear(); sessionStorage.clear();
      const { data } = await supabase.auth.getSession();
      log("after signOut: " + (data.session ? "STILL SIGNED_IN ❌" : "SIGNED_OUT ✅"));
      setAuth(data.session);
    }catch(e){
      log("❌ signOut failed: " + (e?.message||e));
    }
  };

  $("btnBecomeSeller").onclick = async ()=>{
    try{
      const { data: ses } = await supabase.auth.getSession();
      if(!ses.session?.user){ log("⚠️ 先登录"); return; }
      const userId = ses.session.user.id;
      log("Create seller… user=" + userId);

      const { error } = await supabase.from("sellers")
        .upsert({ user_id: userId, shop_name: "My Shop" }, { onConflict:"user_id" });

      if(error) throw error;
      log("✅ Become Seller ok");
    }catch(e){
      log("❌ Become Seller failed: " + (e?.message||e));
    }
  };

  $("btnAddProduct").onclick = async ()=>{
    try{
      const { data: ses } = await supabase.auth.getSession();
      if(!ses.session?.user){ log("⚠️ 先登录"); return; }
      const userId = ses.session.user.id;

      const title = "Test Product " + Math.floor(Math.random()*9999);
      const price_cents = 199;
      const stock = 10;

      log("Add product…");
      const { error } = await supabase.from("products").insert({
        seller_id: userId, title, price_cents, stock
      });
      if(error) throw error;
      log("✅ Add product ok: " + title);
    }catch(e){
      log("❌ Add product failed: " + (e?.message||e));
      log("提示：你必须先 Become Seller（并且 RLS policy 要对）");
    }
  };

  $("btnLoadProducts").onclick = async ()=>{
    try{
      log("Load products…");
      const { data, error } = await supabase.from("products")
        .select("id,title,price_cents,stock,created_at").order("created_at",{ascending:false}).limit(20);
      if(error) throw error;

      $("products").innerHTML = (data||[]).map(p =>
        `• ${p.title} — $${(p.price_cents/100).toFixed(2)} — stock:${p.stock}`
      ).join("<br/>") || "（暂无商品）";
      log("✅ Loaded " + (data?.length||0) + " products");
    }catch(e){
      log("❌ Load products failed: " + (e?.message||e));
    }
  };

  boot();
</script>
</body>
</html>
