<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>JKang Market</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body{font-family:Arial;padding:20px;background:#f5f5f5}
    .card{background:white;padding:15px;margin:10px 0;border-radius:8px}
    button{padding:8px 12px;margin-top:5px}
    input{padding:6px;margin:4px 0}
  </style>
</head>
<body>

<h2>JKang Market</h2>

<div id="loginBox">
  <input id="email" placeholder="email">
  <button onclick="login()">Login</button>
  <p id="msg"></p>
</div>

<div id="app" style="display:none">
  <button onclick="logout()">Logout</button>
  <h3>发布商品</h3>
  <input id="title" placeholder="商品名">
  <input id="price" placeholder="价格 (SGD)">
  <button onclick="createProduct()">发布</button>

  <h3>商品列表</h3>
  <div id="products"></div>
</div>

<script>
const supabase = window.supabase.createClient(
  "https://zdfoelcwmmbvwtjhfixv.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpkZm9lbGN3bW1idnd0amhmaXh2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MzAzNjEsImV4cCI6MjA4NzMwNjM2MX0.Ije9hEA0q4NFnQlThh75BV-MQ0Ph95MFTss3FO2ANWc"
);

async function login(){
  const email = document.getElementById("email").value;
  const { error } = await supabase.auth.signInWithOtp({
    email,
    options:{ emailRedirectTo: window.location.origin }
  });
  document.getElementById("msg").innerText =
    error ? error.message : "Check your email!";
}

async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

async function createProduct(){
  const user = (await supabase.auth.getUser()).data.user;
  if(!user) return alert("not logged in");

  // 确保 seller 存在
  await supabase.rpc("ensure_seller");

  const title = document.getElementById("title").value;
  const price = parseFloat(document.getElementById("price").value) * 100;

  const { error } = await supabase.from("products").insert({
    seller_id: user.id,
    title,
    price_cents: price,
    stock: 10
  });

  if(error) alert(error.message);
  else{
    alert("发布成功");
    loadProducts();
  }
}

async function loadProducts(){
  const { data } = await supabase.from("products")
    .select("*")
    .eq("is_active", true);

  const box = document.getElementById("products");
  box.innerHTML = "";

  data.forEach(p=>{
    const div = document.createElement("div");
    div.className="card";
    div.innerHTML = `
      <b>${p.title}</b><br>
      SGD ${(p.price_cents/100).toFixed(2)}<br>
      <button onclick="buy('${p.id}', ${p.price_cents})">购买</button>
    `;
    box.appendChild(div);
  });
}

async function buy(id, price){
  const user = (await supabase.auth.getUser()).data.user;
  if(!user) return alert("login first");

  const { data: order } = await supabase.from("orders")
    .insert({ buyer_id:user.id, total_cents:price })
    .select()
    .single();

  await supabase.from("order_items").insert({
    order_id: order.id,
    product_id: id,
    title_snapshot: "item",
    price_cents_snapshot: price,
    qty:1
  });

  alert("下单成功（未付款版）");
}

supabase.auth.onAuthStateChange((event, session)=>{
  if(session){
    document.getElementById("loginBox").style.display="none";
    document.getElementById("app").style.display="block";
    loadProducts();
  }
});
</script>

</body>
</html>
